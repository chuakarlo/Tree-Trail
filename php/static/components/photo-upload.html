<div class="uploaded">
  {{# photos }}
  <div class="photo">
    <img src="{{path}}/{{.}}" id="path">
    <button type="button" class="close" on-click="removePhoto">&times;</button>
    <script>
      var test = {
        'path'  : document.getElementById("path").src,
        'gps'   : 'latitude'
      }
      $.ajax({
        url: "/photos",
        type: "GET",
        data: test,
      }).done(function(data){
        $(".latitude").val(data);
        console.log(data);
      });

      var test = {
        'path'  : document.getElementById("path").src,
        'gps'   : 'longitude'
      }
      $.ajax({
        url: "/photos",
        type: "GET",
        data: test,
      }).done(function(data){
        $(".longitude").val(data);
        console.log(data);
      });
    </script>
  </div>
  {{/}}
</div>

{{^uploading}}<button type="button" class="btn btn-default" on-click="openFileDialog">Upload photos</button>{{/}}
{{#uploading}}<button type="button" class="btn btn-default">Uploading. Please wait.</button>{{/}}
<input type="file" on-change="uploadSelectedFile" accept=".png,.jpg,.gif" multiple />

<style type="text/css">
input[type=file] {
  display: none;
}
.uploaded{
  text-align: left;
}
.photo{
  position: relative;
  display: inline-block;
  vertical-align: top;
  width: 100px;
  margin-bottom: 15px;
  margin-right: 15px;
}
.photo img{
  display: block;
  width: 100%;
  position: relative;
}
.close{
  color: #FFF;
  position: absolute;
  top: 0;
  right: 0;
  opacity: 1;
}
</style>

<script>
component.exports = {
  isolated: true,
  data: {
    path: '',
    photos: [],
    uploading: false,
  },
  oninit: function() {
    this.on('openFileDialog', this.openFileDialog);
    this.on('uploadSelectedFile', this.uploadSelectedFile);
    this.on('removePhoto', this.removePhoto);
  },
  openFileDialog: function(event) {
    $(this.find('input[type=file]')).trigger('click');
  },
  removePhoto: function(event){
    var photos = this.get('photos');
    photos.splice(photos.indexOf(event.context),1);
  },
  uploadSelectedFile: function(event) {
    var component = this;
    var fileInput = this.find('input[type=file]');
    var formData = new FormData();

    for(var i=0; i<fileInput.files.length; i++) {
      var file = fileInput.files[i];
      if(!file) continue;
      formData.append('file', file);
      component.set('uploading', true);
      $.ajax({
        url: "/photos",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
      }).success(function(filename){
        component.push('photos', filename);
      }).always(function(){
        $(fileInput).wrap('<form>').parent('form').trigger('reset').find('input').unwrap();
        component.set('uploading', false);
      });
    }

    // if (!file) return;

    // formData.append('file', file);

    // component.set('uploading', true);
    // $.ajax({
    //   url: "/photos",
    //   type: "POST",
    //   data: formData,
    //   processData: false,
    //   contentType: false,
    // }).success(function(filename){
    //   component.push('photos', filename);
    // }).always(function(){
    //   $(fileInput).wrap('<form>').parent('form').trigger('reset').find('input').unwrap();
    //   component.set('uploading', false);
    // });
  },
};
</script>
